<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.10.xsd">

    <changeSet id="0.1" author="mvgrebenyuk">
        <sql>
            create table company (
                id uuid not null,
                email varchar(100) not null,
                phone varchar(100) not null,
                acc_details_id uuid not null
            );

            create table details (
                id uuid not null,
                compnay_id uuid not null,
                name varchar(100),
                surname varchar(100)
            );

            create table salepoint (
                id uuid not null,
                company_id uuid not null,
                name varchar(100)
            );

            create table dev_group (
                id uuid not null,
                company_id uuid not null,
                name varchar(100)
            );

            create table device (
                id uuid not null,
                company_id uuid,
                sp_id uuid,
                group_id uuid,
                type varchar(30) not null,
                serial uuid not null,
                status varchar(10) not null,
                image_url text
            );

        </sql>
    </changeSet>

    <changeSet id="0.2" author="mvgrebenyuk">
        <sql>
            create table image (
                id uuid not null,
                company_id uuid,
                image text
            )
        </sql>
    </changeSet>

    <changeSet id="0.3" author="mvgrebenyuk">
        <sql>
            alter table device drop column image_url;
        </sql>
    </changeSet>

    <changeSet id="0.4" author="mvgrebenyuk">
        <sql>
            create table company_images (
                                            company_id uuid not null,
                                            image_id uuid not null,
                                            primary key (company_id, image_id)
            );

            create table salepoint_images (
                                              salepoint_id uuid not null,
                                              image_id uuid not null,
                                              primary key (salepoint_id, image_id)
            );

            create table dev_group_images (
                                              dev_group_id uuid not null,
                                              image_id uuid not null,
                                              primary key (dev_group_id, image_id)
            );

            create table device_images (
                                           device_id uuid not null,
                                           image_id uuid not null,
                                           primary key (device_id, image_id)
            );

            create table details_images (
                                            details_id uuid not null,
                                            image_id uuid not null,
                                            primary key (details_id, image_id)
            );
        </sql>
    </changeSet>

    <changeSet id="0.5" author="mvgrebenyuk">
        <sql>
            alter table "company" drop column acc_details_id;
            alter table "company" add column company_type varchar(7) not null;
            alter table details rename column "name" to official_name;
            alter table details drop column surname;
        </sql>
    </changeSet>

    <changeSet id="0.6" author="mvgrebenyuk">
        <sql>
            alter table company drop column email;
            alter table company drop column phone;
            alter table company add column cname varchar(100);

            insert into company (id, cname, company_type) values  (
            '855a398d-1bbc-4271-86d9-ca37ae142fa3', 'Rusap(NORTH)', 'LLC'
            )
        </sql>
    </changeSet>

    <changeSet id="0.7" author="mvgrebenyuk">
        <sql>
            alter table details rename column compnay_id to company_id;
        </sql>
    </changeSet>

    <changeSet id="0.8" author="mvgrebenyuk">
        <sql>
            alter table image add column preview text;
            alter table image add column source text;
            alter table image add column data jsonb;
        </sql>
    </changeSet>

    <changeSet id="0.9" author="mvgrebenyuk">
        <sql>
            alter table salepoint add column address text;
            alter table salepoint add column description text;
            drop table details_images cascade;

            alter table dev_group add column active boolean default false;

            alter table salepoint add constraint sp_uniq_id unique (id);
            alter table company add constraint company_uniq_id unique (id);
            alter table device add constraint device_uniq_id unique (id);
            alter table device add constraint device_uniq_serial unique (serial);
            alter table dev_group add constraint group_uniq_id unique (id);

            alter table advisio_core.device
                add constraint device_sp_fk
                    foreign key (sp_id) references salepoint (id);
            alter table advisio_core.device
                add constraint device_group_fk
                    foreign key (group_id) references dev_group (id);
            alter table advisio_core.device
                add constraint device_company_fk
                    foreign key (company_id) references company (id);

    </sql>
    </changeSet>

    <changeSet id="1.0" author="mvgrebenyuk">
        <sql>
            create table tag (
                id uuid not null primary key unique,
                name varchar(15) not null,
                company_id uuid not null
            );

            alter table tag add constraint name_cid_uniq unique (name, company_id);
            alter table device add column tag_id uuid references tag (id);

            create table template (
                id uuid not null primary key unique,
                url text not null,
                name varchar(100),
                company_id uuid not null references company (id)
            );

            alter table image drop column "source";
            alter table image drop column preview;
            alter table image add column template_id uuid references template(id);
        </sql>
    </changeSet>

    <changeSet id="1.1" author="mvgrebenyuk">
        <sql>
            create table crm_data (
                id uuid not null primary key unique,
                company_id uuid not null references company(id),
                crm_type varchar(15) not null,
                name varchar(30) not null,
                description text
            );

            create table products (
                id uuid not null primary key unique,
                company_id uuid not null references company(id),
                crm_source uuid not null references crm_data(id),
                tech_id varchar(100) not null,
                tech_name varchar(100) not null,
                crm varchar (20) not null,
                sale_name varchar (150),
                value varchar (30)
            );

            create table product_attributes (
                id uuid not null primary key unique,
                product_id uuid not null references products(id),
                tech_id varchar(100) not null,
                tech_name varchar(100) not null,
                sale_name varchar(150),
                value varchar(10)
            );
        </sql>
    </changeSet>

    <changeSet id="1.2" author="mvgrebenyuk">
        <sql>
            alter table template add column creation_dt timestamp not null;
        </sql>
    </changeSet>

    <changeSet id="1.3" author="mvgrebenyuk">
        <sql>
            CREATE TABLE connection_crm (
                                            id uuid PRIMARY KEY unique,
                                            crm_id uuid not null references crm_data(id),
                                            connection_name VARCHAR(255) NOT NULL,
                                            crm_type VARCHAR(50) NOT NULL,
                                            connection_type VARCHAR(50) NOT NULL,
                                            connection_url VARCHAR(255) NOT NULL,
                                            login VARCHAR(255),
                                            password VARCHAR(255),
                                            token VARCHAR(255),
                                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
        </sql>
    </changeSet>

    <changeSet id="1.4" author="mvgrebenyuk">
        <sql>
            alter table crm_data add column connection_id uuid references connection_crm(id);
        </sql>
    </changeSet>

    <changeSet id="1.5" author="mvgrebenyuk">
        <sql>
            alter table crm_data rename to crm;
        </sql>
    </changeSet>

    <changeSet id="1.6" author="mvgrebenyuk">
        <sql>
            alter table products drop column crm;
        </sql>
    </changeSet>

    <changeSet id="1.7" author="mvgrebenyuk">
        <sql>
            ALTER TABLE product_attributes
            ALTER COLUMN value TYPE VARCHAR(100);
        </sql>
    </changeSet>

    <changeSet id="1.8" author="mvgrebenyuk">
        <sql>
            ALTER TABLE images
            ADD COLUMN crm_id uuid references crm(id);
        </sql>
    </changeSet>



</databaseChangeLog>