<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.10.xsd">

    <changeSet id="0.1" author="mvgrebenyuk">
        <sql>
            create table company (
                id uuid not null,
                email varchar(100) not null,
                phone varchar(100) not null,
                acc_details_id uuid not null
            );

            create table details (
                id uuid not null,
                compnay_id uuid not null,
                name varchar(100),
                surname varchar(100)
            );

            create table salepoint (
                id uuid not null,
                company_id uuid not null,
                name varchar(100)
            );

            create table dev_group (
                id uuid not null,
                company_id uuid not null,
                name varchar(100)
            );

            create table device (
                id uuid not null,
                company_id uuid,
                sp_id uuid,
                group_id uuid,
                type varchar(30) not null,
                serial uuid not null,
                status varchar(10) not null,
                image_url text
            );

        </sql>
    </changeSet>

    <changeSet id="0.2" author="mvgrebenyuk">
        <sql>
            create table image (
                id uuid not null,
                company_id uuid,
                image text
            )
        </sql>
    </changeSet>

    <changeSet id="0.3" author="mvgrebenyuk">
        <sql>
            alter table device drop column image_url;
        </sql>
    </changeSet>

    <changeSet id="0.4" author="mvgrebenyuk">
        <sql>
            create table company_images (
                                            company_id uuid not null,
                                            image_id uuid not null,
                                            primary key (company_id, image_id)
            );

            create table salepoint_images (
                                              salepoint_id uuid not null,
                                              image_id uuid not null,
                                              primary key (salepoint_id, image_id)
            );

            create table dev_group_images (
                                              dev_group_id uuid not null,
                                              image_id uuid not null,
                                              primary key (dev_group_id, image_id)
            );

            create table device_images (
                                           device_id uuid not null,
                                           image_id uuid not null,
                                           primary key (device_id, image_id)
            );

            create table details_images (
                                            details_id uuid not null,
                                            image_id uuid not null,
                                            primary key (details_id, image_id)
            );
        </sql>
    </changeSet>

    <changeSet id="0.5" author="mvgrebenyuk">
        <sql>
            alter table "company" drop column acc_details_id;
            alter table "company" add column company_type varchar(7) not null;
            alter table details rename column "name" to official_name;
            alter table details drop column surname;
        </sql>
    </changeSet>

    <changeSet id="0.6" author="mvgrebenyuk">
        <sql>
            alter table company drop column email;
            alter table company drop column phone;
            alter table company add column cname varchar(100);

            insert into company (id, cname, company_type) values  (
            '855a398d-1bbc-4271-86d9-ca37ae142fa3', 'Rusap(NORTH)', 'LLC'
            )
        </sql>
    </changeSet>

    <changeSet id="0.7" author="mvgrebenyuk">
        <sql>
            alter table details rename column compnay_id to company_id;
        </sql>
    </changeSet>

    <changeSet id="0.8" author="mvgrebenyuk">
        <sql>
            alter table image add column preview text;
            alter table image add column source text;
            alter table image add column data jsonb;
        </sql>
    </changeSet>

    <changeSet id="0.9" author="mvgrebenyuk">
        <sql>
            alter table salepoint add column address text;
            alter table salepoint add column description text;
            drop table details_images cascade;

            alter table dev_group add column active boolean default false;

            alter table salepoint add constraint sp_uniq_id unique (id);
            alter table company add constraint company_uniq_id unique (id);
            alter table device add constraint device_uniq_id unique (id);
            alter table device add constraint device_uniq_serial unique (serial);
            alter table dev_group add constraint group_uniq_id unique (id);

            alter table advisio_core.device
                add constraint device_sp_fk
                    foreign key (sp_id) references salepoint (id);
            alter table advisio_core.device
                add constraint device_group_fk
                    foreign key (group_id) references dev_group (id);
            alter table advisio_core.device
                add constraint device_company_fk
                    foreign key (company_id) references company (id);

    </sql>
    </changeSet>




</databaseChangeLog>